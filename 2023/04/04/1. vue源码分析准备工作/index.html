<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1. 准备工作1.1 认识FlowFlow 是 facebook 出品的 JavaScript 静态类型检查工具。Vue.js 的源码利用了 Flow 做了静态类型检查，所以了解 Flow 有助于我们阅读源码。  为什么要使用Flow？   JavaScript 是动态类型语言，它的灵活性有目共睹，但是过于灵活的副作用是很容易就写出非常隐蔽的隐患代码，在编译期(就是使用babel将ES6转位ES5">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2023/04/04/1.%20vue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. 准备工作1.1 认识FlowFlow 是 facebook 出品的 JavaScript 静态类型检查工具。Vue.js 的源码利用了 Flow 做了静态类型检查，所以了解 Flow 有助于我们阅读源码。  为什么要使用Flow？   JavaScript 是动态类型语言，它的灵活性有目共睹，但是过于灵活的副作用是很容易就写出非常隐蔽的隐患代码，在编译期(就是使用babel将ES6转位ES5">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-04-04T07:20:21.730Z">
<meta property="article:modified_time" content="2023-04-04T07:20:21.730Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-1. vue源码分析准备工作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/04/04/1.%20vue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2023-04-04T07:20:21.730Z" itemprop="datePublished">2023-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h1><h2 id="1-1-认识Flow"><a href="#1-1-认识Flow" class="headerlink" title="1.1 认识Flow"></a>1.1 认识Flow</h2><p><a target="_blank" rel="noopener" href="https://flow.org/en/docs/getting-started/">Flow</a> 是 facebook 出品的 JavaScript 静态类型检查工具。Vue.js 的源码利用了 Flow 做了静态类型检查，所以了解 Flow 有助于我们阅读源码。</p>
<blockquote>
<p>为什么要使用Flow？</p>
</blockquote>
<blockquote>
<p>JavaScript 是动态类型语言，它的灵活性有目共睹，但是过于灵活的副作用是很容易就写出非常隐蔽的隐患代码，在编译期(就是使用babel将ES6转位ES5阶段)甚至看上去都不会报错，但在运行阶段就可能出现各种奇怪的 bug。</p>
<p>类型检查是当前动态类型语言的发展趋势，所谓类型检查，就是在编译期尽早发现（由类型错误引起的）bug，又不影响代码运行（不需要运行时动态检查类型），使编写 JavaScript 具有和编写 Java 等强类型语言相近的体验。</p>
<p>项目越复杂就越需要通过工具的手段来保证项目的维护性和增强代码的可读性。 Vue.js 在做 2.0 重构的时候，在 ES2015 的基础上，除了 ESLint 保证代码风格之外，也引入了 Flow 做静态类型检查。之所以选择 Flow，主要是因为 Babel 和 ESLint 都有对应的 Flow 插件以支持语法，可以完全沿用现有的构建配置，非常小成本的改动就可以拥有静态类型检查的能力。</p>
</blockquote>
<blockquote>
<p><strong>动态语言（弱类型语言）</strong>是运行时才确定数据类型的语言，变量在使用之前无需申明类型，通常变量的值是被赋值的那个值的类型。比如Php、Asp、JavaScript、Python、Perl等等。</p>
<p><strong>静态语言（强类型语言）</strong>是编译时变量的数据类型就可以确定的语言，大多数静态语言要求在使用变量之前必须声明数据类型。比如Java、C、C++、C#等。</p>
</blockquote>
<h3 id="1-1-1-Flow-的工作方式"><a href="#1-1-1-Flow-的工作方式" class="headerlink" title="1.1.1 Flow 的工作方式"></a>1.1.1 Flow 的工作方式</h3><p>通常类型检查分成 2 种方式：</p>
<ul>
<li>类型推断：通过变量的使用上下文来推断出变量类型，然后根据这些推断来检查类型。</li>
<li>类型注释：事先注释好我们期待的类型，Flow 会基于这些注释来判断。</li>
</ul>
<h4 id="1-1-1-1-类型推断"><a href="#1-1-1-1-类型推断" class="headerlink" title="1.1.1.1 类型推断"></a>1.1.1.1 类型推断</h4><p>它不需要任何代码修改即可进行类型检查，最小化开发者的工作量。它不会强制你改变开发习惯，因为它会自动推断出变量的类型。这就是所谓的类型推断，Flow 最重要的特性之一。</p>
<p>在做测试之前，先安装flow</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g flow-bin  # 全局安装flow</span><br><span class="line"></span><br><span class="line">flow init  # 初始化flow的配置文件  .flowconfig。 .flowconfig 文件里面可以对那些文件检查，不想对哪些文件检查</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// .flowconfig</span><br><span class="line">[ignore]</span><br><span class="line"></span><br><span class="line">[include]</span><br><span class="line"></span><br><span class="line">[libs] 用来描述包含指定库定义的目录</span><br><span class="line"></span><br><span class="line">[lints]</span><br><span class="line"></span><br><span class="line">[options]</span><br><span class="line"></span><br><span class="line">[strict]</span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">split</span> (str) &#123;</span><br><span class="line">  <span class="keyword">return</span> str.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">split</span>(<span class="number">11</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>然后再该文件目录下，执行flow命令</p>
</blockquote>
<p>Flow 检查上述代码后会报错，因为函数 split 期待的参数是字符串，而我们输入了数字。（这就是简单的类型推断）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Error</span> ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ src/index.<span class="property">js</span>:<span class="number">3</span>:<span class="number">14</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Cannot</span> call str.<span class="property">split</span> because property split is missing <span class="keyword">in</span> <span class="title class_">Number</span> [<span class="number">1</span>]. [prop-missing]</span><br><span class="line"></span><br><span class="line">     <span class="number">1</span>│ <span class="comment">/*@flow*/</span></span><br><span class="line">     <span class="number">2</span>│ <span class="keyword">function</span> <span class="title function_">split</span>(<span class="params">str</span>) &#123;</span><br><span class="line">     <span class="number">3</span>│   <span class="keyword">return</span> str.<span class="title function_">split</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">     <span class="number">4</span>│ &#125;</span><br><span class="line"> [<span class="number">1</span>] <span class="number">5</span>│ <span class="title function_">split</span>(<span class="number">11</span>);</span><br></pre></td></tr></table></figure>



<h4 id="1-1-1-2-类型注释"><a href="#1-1-1-2-类型注释" class="headerlink" title="1.1.1.2 类型注释"></a>1.1.1.2 类型注释</h4><p>如上所述，类型推断是 Flow 最有用的特性之一，不需要编写类型注释就能获取有用的反馈。但在某些特定的场景下，添加类型注释可以提供更好更明确的检查依据。</p>
<p>考虑如下代码： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">x, y</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">add</span>(<span class="string">&#x27;Hello&#x27;</span>, <span class="number">11</span>)</span><br></pre></td></tr></table></figure>

<p>Flow 检查上述代码时检查不出任何错误，因为从语法层面考虑， + 即可以用在字符串上，也可以用在数字上，我们并没有明确指出 add() 的参数必须为数字。</p>
<p>在这种情况下，我们可以借助类型注释来指明期望的类型。类型注释是以冒号 : 开头，可以在函数参数，返回值，变量声明中使用。</p>
<p>如果我们在上段代码中添加类型注释，就会变成如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">x: number, y: number</span>): number &#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">add</span>(<span class="string">&#x27;Hello&#x27;</span>, <span class="number">11</span>)</span><br></pre></td></tr></table></figure>

<p>现在 Flow 就能检查出错误，因为函数参数的期待类型为数字，而我们提供了字符串。</p>
<p>上面的例子是针对函数的类型注释。接下来我们来看看 Flow 能支持的一些常见的类型注释。</p>
<h5 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="attr">arr</span>: <span class="title class_">Array</span>&lt;number&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">arr.<span class="title function_">push</span>(<span class="string">&#x27;Hello&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>数组类型注释的格式是 Array&lt;T&gt;，T 表示数组中每项的数据类型。在上述代码中，arr 是每项均为数字的数组。如果我们给这个数组添加了一个字符串，Flow 能检查出错误。</p>
<h5 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">  <span class="attr">x</span>: string;           <span class="comment">// x 是字符串</span></span><br><span class="line">  <span class="attr">y</span>: string | number | <span class="keyword">void</span>;  <span class="comment">// y 可以是字符串或者数字</span></span><br><span class="line">  <span class="attr">z</span>: boolean;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">x: string, y: string | number | <span class="keyword">void</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">x</span> = x</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">y</span> = y</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">z</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="attr">bar</span>: <span class="title class_">Bar</span> = <span class="keyword">new</span> <span class="title class_">Bar</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">var</span> <span class="attr">obj</span>: &#123; <span class="attr">a</span>: string, <span class="attr">b</span>: number, <span class="attr">c</span>: <span class="title class_">Array</span>&lt;string&gt;, <span class="attr">d</span>: <span class="title class_">Bar</span> &#125; = &#123;</span><br><span class="line">  <span class="attr">a</span>: <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">  <span class="attr">b</span>: <span class="number">11</span>,</span><br><span class="line">  <span class="attr">c</span>: [<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>],</span><br><span class="line">  <span class="attr">d</span>: <span class="keyword">new</span> <span class="title class_">Bar</span>(<span class="string">&#x27;hello&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类的类型注释格式如上，可以对类自身的属性做类型检查，也可以对构造函数的参数做类型检查。这里需要注意的是，属性 y 的类型中间用 | 做间隔，表示 y 的类型即可以是字符串也可以是数字。<br>对象的注释类型类似于类，需要指定对象属性的类型。</p>
<h5 id="Null"><a href="#Null" class="headerlink" title="Null"></a>Null</h5><p>若想任意类型 T 可以为 null 或者 undefined，只需类似如下写成 ?T 的格式即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*@flow*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="attr">foo</span>: ?string = <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<p>此时，foo 可以为字符串，也可以为 null。</p>
<p>目前我们只列举了 Flow 的一些常见的类型注释。如果想了解所有类型注释，请移步 Flow 的<a target="_blank" rel="noopener" href="https://flow.org/en/docs/types/">官方文档</a>。 </p>
<h4 id="1-1-1-3-Flow-在-Vue-js-源码中的应用"><a href="#1-1-1-3-Flow-在-Vue-js-源码中的应用" class="headerlink" title="1.1.1.3 Flow 在 Vue.js 源码中的应用"></a>1.1.1.3 Flow 在 Vue.js 源码中的应用</h4><p>有时候我们想引用第三方库，或者自定义一些类型，但 Flow 并不认识，因此检查的时候会报错。为了解决这类问题，Flow 提出了一个 <code>libdef</code> 的概念，可以用来识别这些第三方库或者是自定义类型，而 Vue.js 也利用了这一特性。  libdef -&gt; lib 库 def 模块定义文件</p>
<p>在 Vue.js 的主目录下有 <code>.flowconfig</code> 文件， 它是 Flow 的配置文件，感兴趣的同学可以看<a target="_blank" rel="noopener" href="https://flow.org/en/docs/config/">官方文档</a>。这其中的 <code>[libs]</code> 部分用来描述包含指定库定义的目录，默认是名为 <code>flow-typed</code> 的目录。</p>
<p>这里 <code>[libs]</code> 配置的是 <code>flow</code>，表示指定的库定义都在 <code>flow</code> 文件夹内。我们打开这个目录，会发现文件如下： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">flow</span><br><span class="line">├── compiler.js        # 编译相关</span><br><span class="line">├── component.js       # 组件数据结构</span><br><span class="line">├── global-api.js      # Global API 结构</span><br><span class="line">├── modules.js         # 第三方库定义</span><br><span class="line">├── options.js         # 选项相关</span><br><span class="line">├── ssr.js             # 服务端渲染相关</span><br><span class="line">├── vnode.js           # 虚拟 node 相关</span><br></pre></td></tr></table></figure>



<p>可以看到，Vue.js 有很多自定义类型的定义，在阅读源码的时候，如果遇到某个类型并想了解它完整的数据结构的时候，可以回来翻阅这些数据结构的定义。</p>
<p><strong>总结</strong></p>
<p>通过对 Flow 的认识，有助于我们阅读 Vue 的源码，并且这种静态类型检查的方式非常有利于大型项目源码的开发和维护。类似 Flow 的工具还有如 TypeScript，感兴趣的同学也可以自行去了解一下。</p>
<h2 id="1-2-vue-js-源码目录设计"><a href="#1-2-vue-js-源码目录设计" class="headerlink" title="1.2 vue.js 源码目录设计"></a>1.2 vue.js 源码目录设计</h2><p>这里使用的使用<a target="_blank" rel="noopener" href="https://cdn.bootcdn.net/ajax/libs/vue/2.5.17-beta.0/vue.runtime.js">https://cdn.bootcdn.net/ajax/libs/vue/2.5.17-beta.0/vue.runtime.js</a> </p>
<p>vue2.5.17-beta.0版本</p>
<p>Vue.js 的源码都在 src 目录下，其目录结构如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├── compiler        # 编译相关 </span><br><span class="line">├── core            # 核心代码 </span><br><span class="line">├── platforms       # 不同平台的支持</span><br><span class="line">├── server          # 服务端渲染</span><br><span class="line">├── sfc             # .vue 文件解析</span><br><span class="line">├── shared          # 共享代码</span><br></pre></td></tr></table></figure>

<p>vue2.0的很大改进就是引入了Virtual DOM，Virtual DOM生成其实就是执行了render function，平时写vue的时候，我们很少手写render，一般都是写template，template To render function 的逻辑就在compiler目录</p>
<h3 id="1-2-1-compiler"><a href="#1-2-1-compiler" class="headerlink" title="1.2.1 compiler"></a>1.2.1 compiler</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">compiler</span><br><span class="line">├── codegen</span><br><span class="line">├── directives</span><br><span class="line">├── parser</span><br><span class="line">├── codeframe.js</span><br><span class="line">├── create-compiler.js</span><br><span class="line">├── error-detector.js</span><br><span class="line">├── helper.js</span><br><span class="line">├── index.js</span><br><span class="line">├── optimizer.js</span><br><span class="line">├── to-function.js</span><br></pre></td></tr></table></figure>



<p>compiler 目录包含 Vue.js 所有编译相关的代码。<strong>它包括把模板解析成 ast 语法树，ast 语法树优化，代码生成等功能。</strong></p>
<p>编译的工作可以在构建时做（借助 webpack、vue-loader 等辅助插件）；也可以在运行时做，使用包含构建功能的 Vue.js。显然，编译是一项耗性能的工作，所以更推荐前者——离线编译。</p>
<h3 id="1-2-2-core"><a href="#1-2-2-core" class="headerlink" title="1.2.2 core"></a>1.2.2 core</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">core</span><br><span class="line">├── components</span><br><span class="line">├── global-api</span><br><span class="line">├── instance</span><br><span class="line">├── observer</span><br><span class="line">├── util</span><br><span class="line">├── vdom</span><br><span class="line">├── config.js</span><br><span class="line">├── index.js</span><br></pre></td></tr></table></figure>



<p>core 目录包含了 Vue.js 的核心代码，包括内置组件、全局 API 封装，Vue 实例化、观察者、虚拟 DOM、工具函数等等。</p>
<p>这里的代码可谓是 Vue.js 的灵魂，也是我们之后需要重点分析的地方。</p>
<h3 id="1-2-3-platform"><a href="#1-2-3-platform" class="headerlink" title="1.2.3 platform"></a>1.2.3 platform</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">platform</span><br><span class="line">├── web</span><br><span class="line">  ├── compiler</span><br><span class="line">  ├── runtime</span><br><span class="line">  ├── server</span><br><span class="line">  ├── util</span><br><span class="line">  ├── entry-compiler.js</span><br><span class="line">  ├── entry-runtime-with-compiler.js</span><br><span class="line">  ├── entry-runtime.js</span><br><span class="line">  ├── ...</span><br><span class="line">├── weex</span><br><span class="line">  ├── ...</span><br></pre></td></tr></table></figure>



<p>Vue.js 是一个跨平台的 MVVM 框架，它可以跑在 web 上，也可以配合 weex 跑在 natvie 客户端上。<strong>platform 是 Vue.js 的入口，2 个目录代表 2 个主要入口，分别打包成运行在 web 上和 weex 上的 Vue.js。</strong></p>
<p>我们会重点分析 web 入口打包后的 Vue.js，对于 weex 入口打包的 Vue.js，感兴趣的同学可以自行研究。</p>
<h3 id="1-2-4-server"><a href="#1-2-4-server" class="headerlink" title="1.2.4 server"></a>1.2.4 server</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">├── bundle-renderer</span><br><span class="line">├── optimizing-compiler</span><br><span class="line">├── template-renderer</span><br><span class="line">├── webpack-plugin</span><br><span class="line">├── ....</span><br></pre></td></tr></table></figure>



<p>Vue.js 2.0 支持了服务端渲染，所有服务端渲染相关的逻辑都在这个目录下。注意：这部分代码是跑在服务端的 Node.js，不要和跑在浏览器端的 Vue.js 混为一谈。</p>
<p>服务端渲染主要的工作是把组件渲染为服务器端的 HTML 字符串，将它们直接发送到浏览器，最后将静态标记”混合”为客户端上完全交互的应用程序。</p>
<h3 id="1-2-5-sfc"><a href="#1-2-5-sfc" class="headerlink" title="1.2.5 sfc"></a>1.2.5 sfc</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sfc</span><br><span class="line">├── parser.js</span><br></pre></td></tr></table></figure>



<p>通常我们开发 Vue.js 都会借助 webpack 构建， 然后通过 .vue 单文件的编写组件。</p>
<p>这个目录下的代码逻辑会把 .vue 文件内容解析成一个 JavaScript 的对象。</p>
<h3 id="1-2-6-shared"><a href="#1-2-6-shared" class="headerlink" title="1.2.6 shared"></a>1.2.6 shared</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shared</span><br><span class="line">├── constants.js</span><br><span class="line">├── util.js</span><br></pre></td></tr></table></figure>



<p>Vue.js 会定义一些工具方法，这里定义的工具方法都是会被浏览器端的 Vue.js 和服务端的 Vue.js 所共享的。</p>
<h2 id="1-3-Vue-js-源码构建"><a href="#1-3-Vue-js-源码构建" class="headerlink" title="1.3  Vue.js 源码构建"></a>1.3  Vue.js 源码构建</h2><p>Vue.js 源码是基于 <a target="_blank" rel="noopener" href="https://github.com/rollup/rollup">Rollup</a> 构建的，它的构建相关配置都在 scripts 目录下。 </p>
<blockquote>
<p>Rollup 和webpack都是构建工具，webpack功能更加强大，可以把一些图片,js资源变为js。rollup更加适合一些JS库的编译，他只对js文件处理，所以更加轻量</p>
</blockquote>
<blockquote>
<p>在开发应用时使用 Webpack，开发库时使用 Rollup</p>
</blockquote>
<h3 id="1-3-1-构建脚本"><a href="#1-3-1-构建脚本" class="headerlink" title="1.3.1 构建脚本"></a>1.3.1 构建脚本</h3><p>通常一个基于 NPM 托管的项目都会有一个 package.json 文件，它是对项目的描述文件，它的内容实际上是一个标准的 JSON 对象。</p>
<p>name 是包的名字，main是npm包的入口，module也是默认入口。</p>
<p>我们通常会配置 script 字段作为 NPM 的执行脚本，Vue.js 源码构建的脚本如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;build&quot;: &quot;node scripts/build.js&quot;,</span><br><span class="line">    &quot;build:ssr&quot;: &quot;npm run build -- web-runtime-cjs,web-server-renderer&quot;,</span><br><span class="line">    &quot;build:weex&quot;: &quot;npm run build --weex&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里总共有 3 条命令，作用都是构建 Vue.js，后面 2 条是在第一条命令的基础上，添加一些环境参数。</p>
<p>当在命令行运行 npm run build 的时候，实际上就会执行 node scripts&#x2F;build.js，接下来我们来看看它实际是怎么构建的</p>
<h3 id="1-3-2-构建过程"><a href="#1-3-2-构建过程" class="headerlink" title="1.3.2 构建过程"></a>1.3.2 构建过程</h3><p>我们对于构建过程分析是基于源码的，先打开构建的入口 JS 文件</p>
<p>在 scripts&#x2F;build.js 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!fs.<span class="title function_">existsSync</span>(<span class="string">&#x27;dist&#x27;</span>)) &#123;</span><br><span class="line">  fs.<span class="title function_">mkdirSync</span>(<span class="string">&#x27;dist&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回的是一个数组</span></span><br><span class="line"><span class="keyword">let</span> builds = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>).<span class="title function_">getAllBuilds</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// filter builds via command line arg</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">argv</span>[<span class="number">2</span>]) &#123;</span><br><span class="line">  <span class="keyword">const</span> filters = process.<span class="property">argv</span>[<span class="number">2</span>].<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">  <span class="comment">// 过滤不需要编译的</span></span><br><span class="line">  builds = builds.<span class="title function_">filter</span>(<span class="function"><span class="params">b</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> filters.<span class="title function_">some</span>(<span class="function"><span class="params">f</span> =&gt;</span> b.<span class="property">output</span>.<span class="property">file</span>.<span class="title function_">indexOf</span>(f) &gt; -<span class="number">1</span> || b.<span class="property">_name</span>.<span class="title function_">indexOf</span>(f) &gt; -<span class="number">1</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// filter out weex builds by default</span></span><br><span class="line">  builds = builds.<span class="title function_">filter</span>(<span class="function"><span class="params">b</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> b.<span class="property">output</span>.<span class="property">file</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;weex&#x27;</span>) === -<span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">build</span>(builds)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">build</span> (builds) &#123;</span><br><span class="line">  <span class="keyword">let</span> built = <span class="number">0</span> <span class="comment">// 计数器</span></span><br><span class="line">  <span class="keyword">const</span> total = builds.<span class="property">length</span></span><br><span class="line">  <span class="comment">// 一个一个去编译</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">next</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">buildEntry</span>(builds[built]).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      built++</span><br><span class="line">      <span class="keyword">if</span> (built &lt; total) &#123;</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(logError)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildEntry</span> (config) &#123;</span><br><span class="line">  <span class="keyword">const</span> output = config.<span class="property">output</span></span><br><span class="line">  <span class="keyword">const</span> &#123; file, banner &#125; = output</span><br><span class="line">  <span class="keyword">const</span> isProd = <span class="regexp">/(min|prod)\.js$/</span>.<span class="title function_">test</span>(file)</span><br><span class="line">  <span class="comment">// rollup 所需要的config =&gt; bundle.generate =&gt; outupt</span></span><br><span class="line">  <span class="keyword">return</span> rollup.<span class="title function_">rollup</span>(config)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">bundle</span> =&gt;</span> bundle.<span class="title function_">generate</span>(output))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; output: [&#123; code &#125;] &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isProd) &#123; <span class="comment">// 如果文件是以min.js 或者prod.js 结尾，就进行压缩</span></span><br><span class="line">        <span class="comment">// 进行压缩</span></span><br><span class="line">        <span class="keyword">const</span> minified = (banner ? banner + <span class="string">&#x27;\n&#x27;</span> : <span class="string">&#x27;&#x27;</span>) + terser.<span class="title function_">minify</span>(code, &#123;</span><br><span class="line">          <span class="attr">toplevel</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">output</span>: &#123;</span><br><span class="line">            <span class="attr">ascii_only</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">compress</span>: &#123;</span><br><span class="line">            <span class="attr">pure_funcs</span>: [<span class="string">&#x27;makeMap&#x27;</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;).<span class="property">code</span></span><br><span class="line">        <span class="comment">// 调用write 方法生成在dist目录下</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">write</span>(file, minified, <span class="literal">true</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">write</span>(file, code)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span> (dest, code, zip) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在生成的过程中，可以打一些log信息</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">report</span> (extra) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">blue</span>(path.<span class="title function_">relative</span>(process.<span class="title function_">cwd</span>(), dest)) + <span class="string">&#x27; &#x27;</span> + <span class="title function_">getSize</span>(code) + (extra || <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fs.<span class="title function_">writeFile</span>(dest, code, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">reject</span>(err)</span><br><span class="line">      <span class="keyword">if</span> (zip) &#123;</span><br><span class="line">        zlib.<span class="title function_">gzip</span>(code, <span class="function">(<span class="params">err, zipped</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">reject</span>(err)</span><br><span class="line">          <span class="title function_">report</span>(<span class="string">&#x27; (gzipped: &#x27;</span> + <span class="title function_">getSize</span>(zipped) + <span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">report</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码逻辑非常简单，先从配置文件读取配置，再通过命令行参数对构建配置做过滤，这样就可以构建出不同用途的 Vue.js 了。</p>
<p>接下来我们看一下配置文件，在 scripts&#x2F;config.js 中：</p>
<p>builds里面包含的是不同版本vuejs的编译配置，每个编译配置都有一个entry（入口），dest就是目标</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> banner =</span><br><span class="line">  <span class="string">&#x27;/*!\n&#x27;</span> +</span><br><span class="line">  <span class="string">` * Vue.js v<span class="subst">$&#123;version&#125;</span>\n`</span> +</span><br><span class="line">  <span class="string">` * (c) 2014-<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().getFullYear()&#125;</span> Evan You\n`</span> +</span><br><span class="line">  <span class="string">&#x27; * Released under the MIT License.\n&#x27;</span> +</span><br><span class="line">  <span class="string">&#x27; */&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> builds = &#123;</span><br><span class="line">    <span class="comment">// Runtime only (CommonJS). Used by bundlers e.g. Webpack &amp; Browserify</span></span><br><span class="line">    <span class="string">&#x27;web-runtime-cjs&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">entry</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;web/entry-runtime.js&#x27;</span>),</span><br><span class="line">        <span class="attr">dest</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;dist/vue.runtime.common.js&#x27;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&#x27;cjs&#x27;</span>,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Runtime+compiler CommonJS build (CommonJS)</span></span><br><span class="line">    <span class="string">&#x27;web-full-cjs&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">entry</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;web/entry-runtime-with-compiler.js&#x27;</span>),</span><br><span class="line">        <span class="attr">dest</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;dist/vue.common.js&#x27;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&#x27;cjs&#x27;</span>,</span><br><span class="line">        <span class="attr">alias</span>: &#123; <span class="attr">he</span>: <span class="string">&#x27;./entity-decoder&#x27;</span> &#125;,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Runtime only (ES Modules). Used by bundlers that support ES Modules,</span></span><br><span class="line">    <span class="comment">// e.g. Rollup &amp; Webpack 2</span></span><br><span class="line">    <span class="string">&#x27;web-runtime-esm&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">entry</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;web/entry-runtime.js&#x27;</span>),</span><br><span class="line">        <span class="attr">dest</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;dist/vue.runtime.esm.js&#x27;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&#x27;es&#x27;</span>,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Runtime+compiler CommonJS build (ES Modules)</span></span><br><span class="line">    <span class="string">&#x27;web-full-esm&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">entry</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;web/entry-runtime-with-compiler.js&#x27;</span>),</span><br><span class="line">        <span class="attr">dest</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;dist/vue.esm.js&#x27;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&#x27;es&#x27;</span>,</span><br><span class="line">        <span class="attr">alias</span>: &#123; <span class="attr">he</span>: <span class="string">&#x27;./entity-decoder&#x27;</span> &#125;,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// runtime-only build (Browser)</span></span><br><span class="line">    <span class="string">&#x27;web-runtime-dev&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">entry</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;web/entry-runtime.js&#x27;</span>),</span><br><span class="line">        <span class="attr">dest</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;dist/vue.runtime.js&#x27;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&#x27;umd&#x27;</span>,</span><br><span class="line">        <span class="attr">env</span>: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// runtime-only production build (Browser)</span></span><br><span class="line">    <span class="string">&#x27;web-runtime-prod&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">entry</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;web/entry-runtime.js&#x27;</span>),</span><br><span class="line">        <span class="attr">dest</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;dist/vue.runtime.min.js&#x27;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&#x27;umd&#x27;</span>,</span><br><span class="line">        <span class="attr">env</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Runtime+compiler development build (Browser)</span></span><br><span class="line">    <span class="string">&#x27;web-full-dev&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">entry</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;web/entry-runtime-with-compiler.js&#x27;</span>),</span><br><span class="line">        <span class="attr">dest</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;dist/vue.js&#x27;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&#x27;umd&#x27;</span>,</span><br><span class="line">        <span class="attr">env</span>: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">        <span class="attr">alias</span>: &#123; <span class="attr">he</span>: <span class="string">&#x27;./entity-decoder&#x27;</span> &#125;,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// Runtime+compiler production build  (Browser)</span></span><br><span class="line">    <span class="string">&#x27;web-full-prod&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">entry</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;web/entry-runtime-with-compiler.js&#x27;</span>),</span><br><span class="line">        <span class="attr">dest</span>: <span class="title function_">resolve</span>(<span class="string">&#x27;dist/vue.min.js&#x27;</span>),</span><br><span class="line">        <span class="attr">format</span>: <span class="string">&#x27;umd&#x27;</span>,</span><br><span class="line">        <span class="attr">env</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">        <span class="attr">alias</span>: &#123; <span class="attr">he</span>: <span class="string">&#x27;./entity-decoder&#x27;</span> &#125;,</span><br><span class="line">        banner</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// genConfig 获取到builds里面的key，通过key拿到builds里面的对象</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">genConfig</span> (name) &#123;</span><br><span class="line">  <span class="keyword">const</span> opts = builds[name]</span><br><span class="line">  <span class="comment">// 构造出一个新的config对象，因为这个配置结构才是rollup所需要格式的配置结构</span></span><br><span class="line">  <span class="keyword">const</span> config = &#123;</span><br><span class="line">    <span class="attr">input</span>: opts.<span class="property">entry</span>,<span class="comment">// 比如我们自己定义的叫做entry，rollup是叫做input</span></span><br><span class="line">    <span class="attr">external</span>: opts.<span class="property">external</span>,</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">      <span class="title function_">flow</span>(),</span><br><span class="line">      <span class="title function_">alias</span>(<span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, aliases, opts.<span class="property">alias</span>))</span><br><span class="line">    ].<span class="title function_">concat</span>(opts.<span class="property">plugins</span> || []),</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">      <span class="attr">file</span>: opts.<span class="property">dest</span>,</span><br><span class="line">      <span class="attr">format</span>: opts.<span class="property">format</span>,</span><br><span class="line">      <span class="attr">banner</span>: opts.<span class="property">banner</span>,</span><br><span class="line">      <span class="attr">name</span>: opts.<span class="property">moduleName</span> || <span class="string">&#x27;Vue&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onwarn</span>: <span class="function">(<span class="params">msg, warn</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="regexp">/Circular/</span>.<span class="title function_">test</span>(msg)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(msg)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// built-in vars</span></span><br><span class="line">  <span class="keyword">const</span> vars = &#123;</span><br><span class="line">    <span class="attr">__WEEX__</span>: !!opts.<span class="property">weex</span>,</span><br><span class="line">    <span class="attr">__WEEX_VERSION__</span>: weexVersion,</span><br><span class="line">    <span class="attr">__VERSION__</span>: version</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// feature flags</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(featureFlags).<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    vars[<span class="string">`process.env.<span class="subst">$&#123;key&#125;</span>`</span>] = featureFlags[key]</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// build-specific env</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">env</span>) &#123;</span><br><span class="line">    vars[<span class="string">&#x27;process.env.NODE_ENV&#x27;</span>] = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(opts.<span class="property">env</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  config.<span class="property">plugins</span>.<span class="title function_">push</span>(<span class="title function_">replace</span>(vars))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">transpile</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    config.<span class="property">plugins</span>.<span class="title function_">push</span>(<span class="title function_">buble</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(config, <span class="string">&#x27;_name&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">value</span>: name</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">TARGET</span>) &#123;</span><br><span class="line">  <span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">genConfig</span>(process.<span class="property">env</span>.<span class="property">TARGET</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">exports</span>.<span class="property">getBuild</span> = genConfig</span><br><span class="line">  <span class="built_in">exports</span>.<span class="property">getAllBuilds</span> = <span class="function">() =&gt;</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(builds).<span class="title function_">map</span>(genConfig)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里列举了一些 Vue.js 构建的配置，关于还有一些服务端渲染 webpack 插件以及 weex 的打包配置就不列举了。</p>
<p>对于单个配置，它是遵循 Rollup 的构建规则的。</p>
<ul>
<li>其中 entry 属性表示构建的入口 JS 文件地址</li>
<li>dest 属性表示构建后的 JS 文件地址。</li>
<li>format 属性表示构建的格式，cjs 表示构建出来的文件遵循 CommonJS 规范，es 表示构建出来的文件遵循 ES Module 规范。 umd 表示构建出来的文件遵循 UMD 规范。</li>
<li>banner 其实就是构建后的注释</li>
</ul>
<p>以 web-runtime-cjs 配置为例，它的 entry 是resolve(‘web&#x2F;entry-runtime.js’)，先来看一下 resolve 函数的定义。</p>
<p>源码目录：<code>scripts/config.js</code> </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> aliases = <span class="built_in">require</span>(<span class="string">&#x27;./alias&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resolve</span> = p =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> base = p.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">if</span> (aliases[base]) &#123;</span><br><span class="line">    <span class="keyword">return</span> path.<span class="title function_">resolve</span>(aliases[base], p.<span class="title function_">slice</span>(base.<span class="property">length</span> + <span class="number">1</span>))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../&#x27;</span>, p)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 resolve 函数实现非常简单，它先把 resolve 函数传入的参数 p 通过 &#x2F; 做了分割成数组，然后取数组第一个元素设置为 base。在我们这个例子中，参数 p 是 web&#x2F;entry-runtime.js，那么 base 则为 web。base 并不是实际的路径，它的真实路径借助了别名的配置，我们来看一下别名配置的代码，</p>
<p>在 <code>scripts/alias</code> 中： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">vue</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/platforms/web/entry-runtime-with-compiler&#x27;</span>),</span><br><span class="line">  <span class="attr">compiler</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/compiler&#x27;</span>),</span><br><span class="line">  <span class="attr">core</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/core&#x27;</span>),</span><br><span class="line">  <span class="attr">shared</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/shared&#x27;</span>),</span><br><span class="line">  <span class="attr">web</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/platforms/web&#x27;</span>),</span><br><span class="line">  <span class="attr">weex</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/platforms/weex&#x27;</span>),</span><br><span class="line">  <span class="attr">server</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/server&#x27;</span>),</span><br><span class="line">  <span class="attr">entries</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/entries&#x27;</span>),</span><br><span class="line">  <span class="attr">sfc</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../src/sfc&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很显然，这里 <code>web</code> 对应的真实的路径是 <code>path.resolve(__dirname, &#39;../src/platforms/web&#39;)</code>，这个路径就找到了 Vue.js 源码的 web 目录。 然后 resolve 函数通过 path.resolve(aliases[base], p.slice(base.length + 1)) 找到了最终路径，它就是 Vue.js 源码 web 目录下的 entry-runtime.js。因此，web-runtime-cjs 配置对应的入口文件就找到了。</p>
<p>它经过 Rollup 的构建打包后，最终会在 dist 目录下生成 vue.runtime.common.js。</p>
<h3 id="1-3-3-Runtime-Only-VS-Runtime-Compiler"><a href="#1-3-3-Runtime-Only-VS-Runtime-Compiler" class="headerlink" title="1.3.3 Runtime Only VS Runtime+Compiler"></a>1.3.3 Runtime Only VS Runtime+Compiler</h3><p>通常我们利用 vue-cli 去初始化我们的 Vue.js 项目的时候会询问我们用 Runtime Only 版本的还是 Runtime+Compiler 版本。下面我们来对比这两个版本。</p>
<ul>
<li>Runtime Only</li>
</ul>
<p>我们在使用 Runtime Only 版本的 Vue.js 的时候，通常需要借助如 webpack 的 vue-loader 工具把 .vue 文件编译成 JavaScript，因为是在编译阶段做的，所以它只包含运行时的 Vue.js 代码，因此代码体积也会更轻量。</p>
<blockquote>
<p>会把我们的template模板变为函数，也就是说运行时不带编译，编译是在离线的时候做</p>
</blockquote>
<ul>
<li>Runtime+Compiler</li>
</ul>
<p>我们如果没有对代码做预编译，但又使用了 Vue 的 template 属性并传入一个字符串，则需要在客户端编译模板，如下所示：</p>
<blockquote>
<p>它是在运行时候编译的</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要编译器的版本(也就是需要Runtime+Compiler版本)</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&#x27;&lt;div&gt;&#123;&#123; hi &#125;&#125;&lt;/div&gt;&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这种情况不需要 （这个就不需要compiler版本）</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  render (h) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, <span class="variable language_">this</span>.<span class="property">hi</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为在 Vue.js 2.0 中，最终渲染都是通过 render 函数，如果写 template 属性，则需要编译成 render 函数，那么这个编译过程会发生运行时，所以需要带有编译器的版本。</p>
<p>很显然，这个编译过程对性能会有一定损耗，所以通常我们更推荐使用 Runtime-Only 的 Vue.js。</p>
<p><strong>总结</strong></p>
<p>通过这一节的分析，我们可以了解到 Vue.js 的构建打包过程，也知道了不同作用和功能的 Vue.js 它们对应的入口以及最终编译生成的 JS 文件。尽管在实际开发过程中我们会用 Runtime Only 版本开发比较多，但为了分析 Vue 的编译过程，我们这门课重点分析的源码是 Runtime+Compiler 的 Vue.js。</p>
<h2 id="1-4-从入口开始"><a href="#1-4-从入口开始" class="headerlink" title="1.4 从入口开始"></a>1.4 从入口开始</h2><p>我们之前提到过 Vue.js 构建过程，在 web 应用下，我们来分析 Runtime + Compiler 构建出来的 Vue.js，它的入口是 <code>src/platforms/web/entry-runtime-with-compiler.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&#x27;core/config&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; warn, cached &#125; <span class="keyword">from</span> <span class="string">&#x27;core/util/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; mark, measure &#125; <span class="keyword">from</span> <span class="string">&#x27;core/util/perf&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;./runtime/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; query &#125; <span class="keyword">from</span> <span class="string">&#x27;./util/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; compileToFunctions &#125; <span class="keyword">from</span> <span class="string">&#x27;./compiler/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; shouldDecodeNewlines, shouldDecodeNewlinesForHref &#125; <span class="keyword">from</span> <span class="string">&#x27;./util/compat&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> idToTemplate = <span class="title function_">cached</span>(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> el = <span class="title function_">query</span>(id)</span><br><span class="line">    <span class="keyword">return</span> el &amp;&amp; el.<span class="property">innerHTML</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mount = <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">el?: string | Element,</span></span><br><span class="line"><span class="params"> hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">    <span class="comment">// 此时的el就是一个DOM节点</span></span><br><span class="line">    el = el &amp;&amp; <span class="title function_">query</span>(el)</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="comment">// el不能是html或者body</span></span><br><span class="line">    <span class="keyword">if</span> (el === <span class="variable language_">document</span>.<span class="property">body</span> || el === <span class="variable language_">document</span>.<span class="property">documentElement</span>) &#123;</span><br><span class="line">        process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里的this.$options 早已经被vue处理了。沿着vue去找</span></span><br><span class="line">    <span class="keyword">const</span> options = <span class="variable language_">this</span>.<span class="property">$options</span></span><br><span class="line">    <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">    <span class="keyword">if</span> (!options.<span class="property">render</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> template = options.<span class="property">template</span></span><br><span class="line">        <span class="keyword">if</span> (template) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (template.<span class="title function_">charAt</span>(<span class="number">0</span>) === <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">                    template = <span class="title function_">idToTemplate</span>(template)</span><br><span class="line">                    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">                    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !template) &#123;</span><br><span class="line">                        <span class="title function_">warn</span>(</span><br><span class="line">                            <span class="string">`Template element not found or is empty: <span class="subst">$&#123;options.template&#125;</span>`</span>,</span><br><span class="line">                            <span class="variable language_">this</span></span><br><span class="line">                        )</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.<span class="property">nodeType</span>) &#123;</span><br><span class="line">                template = template.<span class="property">innerHTML</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">                    <span class="title function_">warn</span>(<span class="string">&#x27;invalid template option:&#x27;</span> + template, <span class="variable language_">this</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">            template = <span class="title function_">getOuterHTML</span>(el)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (template) &#123;</span><br><span class="line">            <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">            <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">                <span class="title function_">mark</span>(<span class="string">&#x27;compile&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 把template变为render</span></span><br><span class="line">            <span class="keyword">const</span> &#123; render, staticRenderFns &#125; = <span class="title function_">compileToFunctions</span>(template, &#123;</span><br><span class="line">                shouldDecodeNewlines,</span><br><span class="line">                shouldDecodeNewlinesForHref,</span><br><span class="line">                <span class="attr">delimiters</span>: options.<span class="property">delimiters</span>,</span><br><span class="line">                <span class="attr">comments</span>: options.<span class="property">comments</span></span><br><span class="line">            &#125;, <span class="variable language_">this</span>)</span><br><span class="line">            options.<span class="property">render</span> = render</span><br><span class="line">            options.<span class="property">staticRenderFns</span> = staticRenderFns</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">            <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">                <span class="title function_">mark</span>(<span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">                <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;<span class="variable language_">this</span>._name&#125;</span> compile`</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get outerHTML of elements, taking care</span></span><br><span class="line"><span class="comment"> * of SVG elements in IE as well.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getOuterHTML</span> (<span class="attr">el</span>: <span class="title class_">Element</span>): string &#123;</span><br><span class="line">    <span class="comment">// outerHTML设置或获取对象及其内容的HTML形式</span></span><br><span class="line">    <span class="keyword">if</span> (el.<span class="property">outerHTML</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> el.<span class="property">outerHTML</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">        container.<span class="title function_">appendChild</span>(el.<span class="title function_">cloneNode</span>(<span class="literal">true</span>))</span><br><span class="line">        <span class="keyword">return</span> container.<span class="property">innerHTML</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">compile</span> = compileToFunctions</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那么，当我们的代码执行 import Vue from ‘vue’ 的时候，就是从这个入口执行代码来初始化 Vue，<br>那么 Vue 到底是什么，它是怎么初始化的，我们来一探究竟。</p>
<h3 id="1-4-1-Vue的入口"><a href="#1-4-1-Vue的入口" class="headerlink" title="1.4.1 Vue的入口"></a>1.4.1 Vue的入口</h3><p>在这个入口 JS 的上方我们可以找到 Vue 的来源：<code>import Vue from &#39;./runtime/index&#39;</code>，我们先来看一下这块儿的实现，它定义在 src&#x2F;platforms&#x2F;web&#x2F;runtime&#x2F;index.js 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;core/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">&#x27;core/config&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; extend, noop &#125; <span class="keyword">from</span> <span class="string">&#x27;shared/util&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; mountComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;core/instance/lifecycle&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; devtools, inBrowser, isChrome &#125; <span class="keyword">from</span> <span class="string">&#x27;core/util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  query,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  isReservedAttr,</span><br><span class="line">  getTagNamespace,</span><br><span class="line">  isUnknownElement</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;web/util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; patch &#125; <span class="keyword">from</span> <span class="string">&#x27;./patch&#x27;</span></span><br><span class="line"><span class="keyword">import</span> platformDirectives <span class="keyword">from</span> <span class="string">&#x27;./directives/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> platformComponents <span class="keyword">from</span> <span class="string">&#x27;./components/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// install platform specific utils</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">mustUseProp</span> = mustUseProp</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">isReservedTag</span> = isReservedTag</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">isReservedAttr</span> = isReservedAttr</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">getTagNamespace</span> = getTagNamespace</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">isUnknownElement</span> = isUnknownElement</span><br><span class="line"></span><br><span class="line"><span class="comment">// install platform runtime directives &amp; components</span></span><br><span class="line"><span class="title function_">extend</span>(<span class="title class_">Vue</span>.<span class="property">options</span>.<span class="property">directives</span>, platformDirectives)</span><br><span class="line"><span class="title function_">extend</span>(<span class="title class_">Vue</span>.<span class="property">options</span>.<span class="property">components</span>, platformComponents)</span><br><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__patch__</span> = inBrowser ? patch : noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? <span class="title function_">query</span>(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">mountComponent</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>

<p>这里关键的代码是 <code>import Vue from &#39;core/index&#39;</code>，之后的逻辑都是对 Vue 这个对象做一些扩展，可以先不用看，我们来看一下真正初始化 Vue 的地方，在 <code>src/core/index.js</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;./instance/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; initGlobalAPI &#125; <span class="keyword">from</span> <span class="string">&#x27;./global-api/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; isServerRendering &#125; <span class="keyword">from</span> <span class="string">&#x27;core/util/env&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FunctionalRenderContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;core/vdom/create-functional-component&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">initGlobalAPI</span>(<span class="title class_">Vue</span>)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$isServer&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">get</span>: isServerRendering</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$ssrContext&#x27;</span>, &#123;</span><br><span class="line">  get () &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">$vnode</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">$vnode</span>.<span class="property">ssrContext</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// expose FunctionalRenderContext for ssr runtime helper installation</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>, <span class="string">&#x27;FunctionalRenderContext&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">value</span>: <span class="title class_">FunctionalRenderContext</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">version</span> = <span class="string">&#x27;__VERSION__&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>

<p>这里有 2 处关键的代码，<code>import Vue from &#39;./instance/index&#39;</code> 和 <code>initGlobalAPI(Vue)</code>，初始化全局 Vue API（我们稍后介绍），我们先来看第一部分，在 <code>src/core/instance/index.js</code> 中·：</p>
<h3 id="1-4-2-Vue的定义"><a href="#1-4-2-Vue的定义" class="headerlink" title="1.4.2 Vue的定义"></a>1.4.2 Vue的定义</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; initMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./init&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; stateMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./state&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; renderMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./render&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; eventsMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./events&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; lifecycleMixin &#125; <span class="keyword">from</span> <span class="string">&#x27;./lifecycle&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; warn &#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span> (options) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">        !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>)</span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(<span class="string">&#x27;Vue is a constructor and should be called with the `new` keyword&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">initMixin</span>(<span class="title class_">Vue</span>)</span><br><span class="line"><span class="title function_">stateMixin</span>(<span class="title class_">Vue</span>)</span><br><span class="line"><span class="title function_">eventsMixin</span>(<span class="title class_">Vue</span>)</span><br><span class="line"><span class="title function_">lifecycleMixin</span>(<span class="title class_">Vue</span>)</span><br><span class="line"><span class="title function_">renderMixin</span>(<span class="title class_">Vue</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>

<p>在这里，我们终于看到了 Vue 的庐山真面目，它实际上就是一个用 Function 实现的类，我们只能通过 new Vue 去实例化它。</p>
<blockquote>
<p>有些同学看到这不禁想问，为何 Vue 不用 ES6 的 Class 去实现呢？我们往后看这里有很多 <code>xxxMixin</code> 的函数调用，并把 <code>Vue</code> 当参数传入，它们的功能都是给 Vue 的 prototype 上扩展一些方法（这里具体的细节会在之后的文章介绍，这里不展开），Vue 按功能把这些扩展分散到多个模块中去实现，而不是在一个模块里实现所有，这种方式是用 Class 难以实现的。这么做的好处是非常方便代码的维护和管理，这种编程技巧也非常值得我们去学习。 </p>
</blockquote>
<h3 id="1-4-3-initGlobalAPI"><a href="#1-4-3-initGlobalAPI" class="headerlink" title="1.4.3 initGlobalAPI"></a>1.4.3 initGlobalAPI</h3><p>Vue.js 在整个初始化过程中，<strong>除了给它的原型 prototype 上扩展方法，还会给 Vue 这个对象本身扩展全局的静态方法</strong>，它的定义在 <code>src/core/global-api/index.js</code> 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initGlobalAPI</span> (<span class="title class_">Vue</span>: <span class="title class_">GlobalAPI</span>) &#123;</span><br><span class="line">    <span class="comment">// config</span></span><br><span class="line">    <span class="keyword">const</span> configDef = &#123;&#125;</span><br><span class="line">    configDef.<span class="property">get</span> = <span class="function">() =&gt;</span> config</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">        configDef.<span class="property">set</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">                <span class="string">&#x27;Do not replace the Vue.config object, set individual fields instead.&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>, <span class="string">&#x27;config&#x27;</span>, configDef)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// exposed util methods.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> these are not considered part of the public API - avoid relying on</span></span><br><span class="line">    <span class="comment">// them unless you are aware of the risk.</span></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">util</span> = &#123;</span><br><span class="line">        warn,</span><br><span class="line">        extend,</span><br><span class="line">        mergeOptions,</span><br><span class="line">        defineReactive</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">set</span> = set</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">delete</span> = del</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">nextTick</span> = nextTick</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">options</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="variable constant_">ASSET_TYPES</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">Vue</span>.<span class="property">options</span>[type + <span class="string">&#x27;s&#x27;</span>] = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// this is used to identify the &quot;base&quot; constructor to extend all plain-object</span></span><br><span class="line">    <span class="comment">// components with in Weex&#x27;s multi-instance scenarios.</span></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property">options</span>.<span class="property">_base</span> = <span class="title class_">Vue</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">extend</span>(<span class="title class_">Vue</span>.<span class="property">options</span>.<span class="property">components</span>, builtInComponents)</span><br><span class="line"></span><br><span class="line">    <span class="title function_">initUse</span>(<span class="title class_">Vue</span>)</span><br><span class="line">    <span class="title function_">initMixin</span>(<span class="title class_">Vue</span>)</span><br><span class="line">    <span class="title function_">initExtend</span>(<span class="title class_">Vue</span>)</span><br><span class="line">    <span class="title function_">initAssetRegisters</span>(<span class="title class_">Vue</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里就是在 Vue 上扩展的一些全局方法的定义，Vue 官网中关于全局 API 都可以在这里找到，这里不会介绍细节，会在之后的章节我们具体介绍到某个 API 的时候会详细介绍。有一点要注意的是，Vue.util 暴露的方法最好不要依赖，因为它可能经常会发生变化，是不稳定的。</p>
<p><strong>总结</strong></p>
<p>那么至此，Vue 的初始化过程基本介绍完毕。这一节的目的是让同学们对 Vue 是什么有一个直观的认识，它本质上就是一个用 Function 实现的 Class，然后它的原型 prototype 以及它本身都扩展了一系列的方法和属性，那么 Vue 能做什么，它是怎么做的，我们会在后面的章节一层层帮大家揭开 Vue 的神秘面纱 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/04/04/1.%20vue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/" data-id="clg1xlet70000h4gve1xk8qvr" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2023/04/04/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/04/04/1.%20vue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/04/04/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>